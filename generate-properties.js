/**
 * PROPERTY DATA GENERATOR
 * =======================
 * Run this script to auto-generate properties.js from your folder structure
 * 
 * Usage: node generate-properties.js
 */

const fs = require('fs');
const path = require('path');

const PROJECTS_DIR = './static/images/projects';
const OUTPUT_FILE = './static/js/properties.js';

/**
 * Scan all folders in projects directory
 */
function scanProjects() {
    const projects = {};

    // Check if directory exists
    if (!fs.existsSync(PROJECTS_DIR)) {
        console.error(`‚ùå Directory not found: ${PROJECTS_DIR}`);
        console.log('üí° Make sure you run this from the root of your project');
        process.exit(1);
    }

    const folders = fs.readdirSync(PROJECTS_DIR, { withFileTypes: true })
        .filter(dirent => dirent.isDirectory())
        .map(dirent => dirent.name);

    console.log(`üìÅ Found ${folders.length} folders to scan...\n`);

    folders.forEach(folder => {
        const folderPath = path.join(PROJECTS_DIR, folder);
        const files = fs.readdirSync(folderPath);

        // Get all image files (excluding description file)
        const images = files.filter(file =>
            /\.(jpg|jpeg|png|gif|webp)$/i.test(file) &&
            !file.startsWith('zzz_')
        ).sort(); // Sort alphabetically

        // Use folder name directly as project name
        let projectName = folder;

        projects[folder] = {
            name: projectName,
            location: "Calamba, Laguna",
            folder: folder,
            images: images
        };

        console.log(`‚úì ${projectName}: ${images.length} image${images.length !== 1 ? 's' : ''}`);
    });

    return projects;
}

/**
 * Generate the properties.js file
 */
function generateFile() {
    console.log('üî® Generating properties.js...\n');

    const projects = scanProjects();

    // Format the projects object with proper indentation
    const projectsJson = JSON.stringify(projects, null, 8)
        .replace(/"([^"]+)":/g, '"$1":'); // Keep quotes for folder keys

    const fileContent = `/**
 * AUTO-GENERATED PROPERTY CONFIG
 * ==============================
 * ‚ö†Ô∏è  DO NOT EDIT THIS FILE MANUALLY
 * 
 * Generated: ${new Date().toISOString()}
 * Generator: generate-properties.js
 * 
 * To regenerate: Run 'node generate-properties.js'
 * 
 * WARNING: Manual edits will be overwritten!
 */

window.PROPERTY_DATA = {
    // Base path - DON'T CHANGE THIS
    basePath: "/static/images/projects/",
    
    // ===================================
    // AUTO-GENERATED PROJECTS
    // ===================================
    projects: ${projectsJson},
    
    // ===================================
    // AUTOMATIC FUNCTIONS - DON'T EDIT
    // ===================================
    
    /**
     * Get property with full image paths
     */
    async getProperty(id) {
        const project = this.projects[id];
        if (!project) return null;
        
        // Build full image paths
        const images = project.images.map(filename => 
            this.basePath + project.folder + "/" + filename
        );
        
        // Try to load description
        let description = null;
        try {
            const response = await fetch(this.basePath + project.folder + "/zzz_description.txt");
            if (response.ok) {
                description = await response.text();
            }
        } catch (error) {
            // No description file, that's okay
        }
        
        return {
            id: id,
            name: project.name,
            location: project.location,
            folder: project.folder,
            images: images,
            description: description,
            features: [
                { icon: "fas fa-home", text: "Residential Property" },
                { icon: "fas fa-map-marker-alt", text: project.location },
                { icon: "fas fa-images", text: images.length + " Photo" + (images.length !== 1 ? "s" : "") }
            ]
        };
    },
    
    /**
     * Get all properties
     */
    async getAllProperties() {
        const all = {};
        for (let id in this.projects) {
            all[id] = await this.getProperty(id);
        }
        return all;
    }
};

// Backwards compatibility
window.PROPERTY_CONFIG = window.PROPERTY_DATA;
window.PROPERTY_LOADER = window.PROPERTY_DATA;

/**
 * =============================================
 * HOW TO ADD NEW PROJECTS
 * =============================================
 * 
 * Step 1: Create folder and add files
 * ------------------------------------
 * /static/images/projects/15/
 *   ‚îú‚îÄ‚îÄ photo1.jpg
 *   ‚îú‚îÄ‚îÄ photo2.jpg
 *   ‚îú‚îÄ‚îÄ photo3.jpg
 *   ‚îî‚îÄ‚îÄ zzz_description.txt  (optional)
 * 
 * Step 2: Run the generator
 * -------------------------
 * node generate-properties.js
 * 
 * Step 3: Upload & Done!
 * ----------------------
 * Git will commit the updated properties.js
 * Visit: yoursite.com/property.html?id=15
 * 
 * =============================================
 */
`;

    // Ensure output directory exists
    const outputDir = path.dirname(OUTPUT_FILE);
    if (!fs.existsSync(outputDir)) {
        fs.mkdirSync(outputDir, { recursive: true });
    }

    fs.writeFileSync(OUTPUT_FILE, fileContent);

    console.log(`\n‚úÖ Generated ${OUTPUT_FILE}`);
    console.log(`üì¶ Total projects: ${Object.keys(projects).length}`);
    console.log(`\nüöÄ Ready to commit and push!`);
}

// Run the generator
try {
    generateFile();
} catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
}